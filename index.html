<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gr치fica de Funci칩n con Asintotas</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      color: #333;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background-color: #fff;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    input, button {
      font-size: 16px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      background-color: #007bff;
      color: white;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover {
      background-color: #0056b3;
    }

    #grafico {
      margin-top: 25px;
    }

    #info {
      margin-top: 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>游늻 Gr치fica de Funciones con As칤ntotas</h2>

    <label for="funcion">Escribe la funci칩n (ej: x+2, x**2 - 3, 1/(x-2)):</label>
    <input type="text" id="funcion" placeholder="Ej: 1/(x-2)">

    <button onclick="graficarFuncion()">Graficar y Analizar</button>
    <button onclick="leerExplicacion()">游댉 Escuchar Explicaci칩n</button>

    <div id="info"></div>
    <div id="grafico"></div>
  </div>

  <script>
    let textoExplicacion = "";

    function evaluarFuncion(expr, x) {
      try {
        return eval(expr);
      } catch {
        return NaN;
      }
    }

    function encontrarAsintotasVerticales(expr, xRange) {
      let asintotas = [];
      for (let i = xRange[0]; i <= xRange[1]; i += 0.5) {
        let y1 = evaluarFuncion(expr, i);
        let y2 = evaluarFuncion(expr, i + 0.1);
        if ((Math.abs(y1) > 1e5 || Math.abs(y2) > 1e5 || isNaN(y1)) &&
            Math.abs(y1 - y2) > 50) {
          asintotas.push(parseFloat(i.toFixed(1)));
        }
      }
      return [...new Set(asintotas)];
    }

    function filtrarValoresExtremos(arr) {
      // Elimina valores demasiado grandes para evitar errores visuales
      return arr.filter(y => isFinite(y) && Math.abs(y) < 1e5);
    }

    function graficarFuncion() {
      const expr = document.getElementById('funcion').value;
      const x_vals = [], y_vals = [];
      const xStart = -100, xEnd = 100;

      for (let x = xStart; x <= xEnd; x += 0.2) {
        let y = evaluarFuncion(expr, x);
        if (!isNaN(y) && isFinite(y)) {
          x_vals.push(x);
          y_vals.push(y);
        } else {
          x_vals.push(x);
          y_vals.push(null);
        }
      }

      // Rango limpio
      const yFiltrados = filtrarValoresExtremos(y_vals);
      const minY = Math.min(...yFiltrados);
      const maxY = Math.max(...yFiltrados);

      const funcionPlot = {
        x: x_vals,
        y: y_vals,
        mode: 'lines',
        name: 'Funci칩n',
        line: { color: '#007bff', width: 2 }
      };

      const asintotas = encontrarAsintotasVerticales(expr, [xStart, xEnd]);

      const verticales = asintotas.map(x => ({
        type: 'line',
        x0: x,
        x1: x,
        y0: minY - 10,
        y1: maxY + 10,
        line: {
          color: 'hotpink',
          width: 2,
          dash: 'dot'
        }
      }));

      // As칤ntota horizontal si tiende a valor fijo
      let horizontal = null;
      const promedio = yFiltrados.reduce((a, b) => a + b, 0) / yFiltrados.length;
      const dispersion = Math.max(...yFiltrados) - Math.min(...yFiltrados);
      if (dispersion < 0.1) {
        horizontal = {
          type: 'line',
          x0: xStart,
          x1: xEnd,
          y0: promedio,
          y1: promedio,
          line: {
            color: 'green',
            width: 2,
            dash: 'dot'
          }
        };
      }

      const layout = {
        title: '游늳 Gr치fica de la Funci칩n',
        xaxis: { title: 'x' },
        yaxis: { title: 'f(x)', autorange: true },
        shapes: [...verticales, ...(horizontal ? [horizontal] : [])]
      };

      Plotly.newPlot('grafico', [funcionPlot], layout);

      const dominio = `Todos los reales${asintotas.length ? ` (excepto en x = ${asintotas.join(', ')})` : ''}`;
      const rango = `De ${minY.toFixed(2)} a ${maxY.toFixed(2)}`;
      const rangoTexto = `Todos los reales${(minY < -1e4 || maxY > 1e4) ? ` (excepto valores extremos)` : ` (aproximadamente de ${minY.toFixed(2)} a ${maxY.toFixed(2)})`}`;
      const asintotasV = asintotas.length ? asintotas.join(', ') : 'Ninguna';
      const asintotaH = horizontal ? `y = ${promedio.toFixed(2)}` : 'Ninguna';

      document.getElementById('info').innerHTML = `
        <strong>游늷 Dominio:</strong> ${dominio}<br>
        <strong>游늷 Rango:</strong> ${rangoTexto}<br>
        <strong>游늷 As칤ntotas verticales:</strong> ${asintotasV}<br>
        <strong>游늷 As칤ntota horizontal:</strong> ${asintotaH}
      `;

      textoExplicacion = `Dominio: ${dominio}. Rango: ${rangoTexto}. As칤ntotas verticales: ${asintotasV}. ` +
                         `As칤ntota horizontal: ${asintotaH}.`;
    }

    function leerExplicacion() {
      const voz = new SpeechSynthesisUtterance(textoExplicacion);
      voz.lang = 'es-ES';
      speechSynthesis.cancel();
      speechSynthesis.speak(voz);
    }
  </script>

</body>
</html>
